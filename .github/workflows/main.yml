name: Main Taski workflow

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
#  tests:
#    runs-on: ubuntu-latest
#    services:
#      postgres:
#        image: postgres:13.10
#        env:
#          POSTGRES_USER: django_user
#          POSTGRES_PASSWORD: django_password
#          POSTGRES_DB: django_db
#        ports:
#          - 5432:5432
#        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
#    steps:
#      - uses: actions/checkout@v3
#      - uses: actions/setup-python@v4
#        with:
#          python-version: 3.12
#      - name: Install dependencies
#        run: |
#          python -m pip install --upgrade pip
#          cd backend
#          pip install -r requirements.txt
#          pip install flake8 pytest
#      - name: Test backend
#        env:
#          SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY || 'test-key-for-ci' }}
#          DEBUG: "False"
#          POSTGRES_DB: django_db
#          POSTGRES_USER: django_user
#          POSTGRES_PASSWORD: django_password
#          DB_HOST: localhost
#          DB_PORT: 5432
#          ALLOWED_HOSTS: localhost,127.0.0.1
#        run: |
#          cd backend
#          python -m flake8 .
#          # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
#          python manage.py test

  frontend_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Install frontend deps
        run: |
          cd frontend
          npm ci
      - name: Test frontend
        run: |
          cd frontend
          npm run test

  build_backend:
    runs-on: ubuntu-latest
    needs: [tests, frontend_tests]
    steps:
      - uses: actions/checkout@v3
      - uses: docker/setup-buildx-action@v2
      - uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/taski_backend:latest
            ${{ secrets.DOCKER_USERNAME }}/taski_backend:${{ github.sha }}

  build_frontend:
    runs-on: ubuntu-latest
    needs: [tests, frontend_tests]
    steps:
      - uses: actions/checkout@v3
      - uses: docker/setup-buildx-action@v2
      - uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/taski_frontend:latest
            ${{ secrets.DOCKER_USERNAME }}/taski_frontend:${{ github.sha }}

  build_gateway:
    runs-on: ubuntu-latest
    needs: [tests, frontend_tests]
    steps:
      - uses: actions/checkout@v3
      - uses: docker/setup-buildx-action@v2
      - uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push gateway
        uses: docker/build-push-action@v4
        with:
          context: ./gateway
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/taski_gateway:latest
            ${{ secrets.DOCKER_USERNAME }}/taski_gateway:${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    needs: [build_backend, build_frontend, build_gateway]
    steps:
      - name: copy docker
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          source: docker-compose.production.yml
          target: taski
      - name: Deploy to production
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd /home/taski
            
            echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            
            # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if [ ! -f .env ]; then
              cat > .env << EOF
            # PostgreSQL
            POSTGRES_DB=taski_db
            POSTGRES_USER=taski_user
            POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_HOST=db
            DB_PORT=5432
            
            # Django
            SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
            DEBUG=False
            ALLOWED_HOSTS=${{ secrets.TASKI_DOMAIN }},localhost,127.0.0.1,backend,158.160.31.110
            CSRF_TRUSTED_ORIGINS=https://${{ secrets.TASKI_DOMAIN }},http://${{ secrets.TASKI_DOMAIN }}
            
            # Docker
            DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            EOF
            fi
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–∑—ã –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
            docker compose -f docker-compose.production.yml pull
            docker compose -f docker-compose.production.yml down 2>/dev/null || true
            docker compose -f docker-compose.production.yml up -d
            
            echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (30 —Å–µ–∫)..."
            sleep 30
            
            echo "üìù –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏..."
            docker compose -f docker-compose.production.yml exec -T backend python manage.py migrate --noinput 2>/dev/null || echo "–ú–∏–≥—Ä–∞—Ü–∏–∏ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã"
            
            echo "üóÇÔ∏è –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É..."
            docker compose -f docker-compose.production.yml exec -T backend python manage.py collectstatic --noinput 2>/dev/null || echo "–°—Ç–∞—Ç–∏–∫–∞ —É–∂–µ —Å–æ–±—Ä–∞–Ω–∞"
            
            echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker compose -f docker-compose.production.yml ps
            
            echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏..."
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø–æ—Ä—Ç—É 80 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π HTTP)
            if curl -f http://localhost/ > /dev/null 2>&1; then
              echo "‚úÖ Gateway —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 80"
            else
              echo "‚ö†Ô∏è Gateway –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ localhost:80"
              echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ gateway..."
              docker compose -f docker-compose.production.yml logs gateway --tail=30
              exit 1
            fi
            
            echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"